!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("rxjs/Observable"),require("rxjs/ReplaySubject"),require("rxjs/add/operator/map"),require("rxjs/add/operator/mergeMap"),require("rxjs/add/operator/pluck"),require("rxjs/add/operator/first"),require("rxjs/add/observable/fromEvent"),require("rxjs/add/observable/merge"),require("rxjs/add/observable/throw"),require("rxjs/add/observable/of")):"function"==typeof define&&define.amd?define(["exports","@angular/core","rxjs/Observable","rxjs/ReplaySubject","rxjs/add/operator/map","rxjs/add/operator/mergeMap","rxjs/add/operator/pluck","rxjs/add/operator/first","rxjs/add/observable/fromEvent","rxjs/add/observable/merge","rxjs/add/observable/throw","rxjs/add/observable/of"],r):r((e.ng=e.ng||{},e.ng.asyncLocalStorage=e.ng.asyncLocalStorage||{}),e.ng.core,e.Rx,e.Rx,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable,e.Rx.Observable,e.Rx.Observable,e.Rx.Observable)}(this,function(e,r,t,o,a,n,s,c,i,u,l,b){"use strict";function p(){var e;try{e=new m}catch(r){try{e=new g}catch(r){e=new O}}return new v(e)}var f=function(){function e(){}return e}(),v=function(){function e(e){this.database=e}return e.prototype.getItem=function(e){return this.database.getItem(e)},e.prototype.setItem=function(e,r){return this.database.setItem(e,r)},e.prototype.removeItem=function(e){return this.database.removeItem(e)},e.prototype.clear=function(){return this.database.clear()},e.decorators=[{type:r.Injectable}],e.ctorParameters=[{type:f}],e}(),d=function(e,r){function t(){this.constructor=e}for(var o in r)r.hasOwnProperty(o)&&(e[o]=r[o]);e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)},m=function(e){function a(){e.call(this),this.dbName="ngStorage",this.objectStoreName="localStorage",this.keyPath="key",this.dataPath="value",this.database=new o.ReplaySubject,this.connect()}return d(a,e),a.prototype.getItem=function(e){var r=this;return this.transaction().map(function(r){return r.get(e)}).mergeMap(function(e){var o=t.Observable.fromEvent(e,"success").pluck("target","result").map(function(e){return e?e[r.dataPath]:null});return t.Observable.merge(o,r.toErrorObservable(e,"getter")).first()})},a.prototype.setItem=function(e,r){var o=this;return null==r?t.Observable.of(!0):this.getItem(e).map(function(e){return null==e?"add":"put"}).mergeMap(function(a){return o.transaction("readwrite").mergeMap(function(n){var s=n[a]((c={},c[o.dataPath]=r,c),e);return t.Observable.merge(o.toSuccessObservable(s),o.toErrorObservable(s,"setter")).first();var c})})},a.prototype.removeItem=function(e){var r=this;return this.getItem(e).mergeMap(function(o){return null!=o?r.transaction("readwrite").mergeMap(function(o){var a=o.delete(e);return t.Observable.merge(r.toSuccessObservable(a),r.toErrorObservable(a,"remover")).first()}):t.Observable.of(!0).first()})},a.prototype.clear=function(){var e=this;return this.transaction("readwrite").mergeMap(function(r){var o=r.clear();return t.Observable.merge(e.toSuccessObservable(o),e.toErrorObservable(o,"clearer")).first()})},a.prototype.connect=function(){var e=this,r=indexedDB.open(this.dbName);t.Observable.fromEvent(r,"upgradeneeded").first().subscribe(function(r){var t=r.target.result;t.objectStoreNames.contains(e.objectStoreName)||t.createObjectStore(e.objectStoreName)});var o=t.Observable.fromEvent(r,"success");t.Observable.merge(o,this.toErrorObservable(r,"connection")).first().subscribe(function(r){e.database.next(r.target.result)})},a.prototype.transaction=function(e){var r=this;return void 0===e&&(e="readonly"),this.database.map(function(t){return t.transaction([r.objectStoreName],e).objectStore(r.objectStoreName)})},a.prototype.toSuccessObservable=function(e){return t.Observable.fromEvent(e,"success").map(function(){return!0})},a.prototype.toErrorObservable=function(e,r){return void 0===r&&(r=""),t.Observable.fromEvent(e,"error").mergeMap(function(){return t.Observable.throw(new Error("IndexedDB "+r+" issue."))})},a.decorators=[{type:r.Injectable}],a.ctorParameters=[],a}(f),y=function(e,r){function t(){this.constructor=e}for(var o in r)r.hasOwnProperty(o)&&(e[o]=r[o]);e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)},g=function(e){function o(){e.apply(this,arguments),this.localStorage=localStorage}return y(o,e),o.prototype.getItem=function(e){var r=this.localStorage.getItem(e);if(null!=r)try{r=JSON.parse(r)}catch(e){return t.Observable.throw(new Error("Invalid data in localStorage."))}return t.Observable.of(r)},o.prototype.setItem=function(e,r){return this.localStorage.setItem(e,JSON.stringify(r)),t.Observable.of(!0)},o.prototype.removeItem=function(e){return this.localStorage.removeItem(e),t.Observable.of(!0)},o.prototype.clear=function(){return this.localStorage.clear(),t.Observable.of(!0)},o.decorators=[{type:r.Injectable}],o.ctorParameters=[],o}(f),h=function(e,r){function t(){this.constructor=e}for(var o in r)r.hasOwnProperty(o)&&(e[o]=r[o]);e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)},O=function(e){function o(){e.apply(this,arguments),this.localStorage=new Map}return h(o,e),o.prototype.getItem=function(e){var r=this.localStorage.get(e);return t.Observable.of(void 0!=r?r:null)},o.prototype.setItem=function(e,r){return this.localStorage.set(e,r),t.Observable.of(!0)},o.prototype.removeItem=function(e){return this.localStorage.delete(e),t.Observable.of(!0)},o.prototype.clear=function(){return this.localStorage.clear(),t.Observable.of(!0)},o.decorators=[{type:r.Injectable}],o.ctorParameters=[],o}(f),j=function(){function e(){}return e.decorators=[{type:r.NgModule,args:[{providers:[{provide:v,useFactory:p}]}]}],e.ctorParameters=[],e}();e.AsyncLocalStorageModule=j,e.AsyncLocalStorage=v,Object.defineProperty(e,"__esModule",{value:!0})});