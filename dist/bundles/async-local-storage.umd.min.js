!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("rxjs/Observable"),require("rxjs/ReplaySubject"),require("rxjs/add/operator/map"),require("rxjs/add/operator/mergeMap"),require("rxjs/add/operator/pluck"),require("rxjs/add/operator/first"),require("rxjs/add/observable/fromEvent"),require("rxjs/add/observable/merge"),require("rxjs/add/observable/throw"),require("rxjs/add/observable/of")):"function"==typeof define&&define.amd?define(["exports","@angular/core","rxjs/Observable","rxjs/ReplaySubject","rxjs/add/operator/map","rxjs/add/operator/mergeMap","rxjs/add/operator/pluck","rxjs/add/operator/first","rxjs/add/observable/fromEvent","rxjs/add/observable/merge","rxjs/add/observable/throw","rxjs/add/observable/of"],r):r((e.ng=e.ng||{},e.ng.asyncLocalStorage=e.ng.asyncLocalStorage||{}),e.ng.core,e.Rx,e.Rx,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable.prototype,e.Rx.Observable,e.Rx.Observable,e.Rx.Observable,e.Rx.Observable)}(this,function(e,r,t,o,a,n,s,c,u,i,b,l){"use strict";function p(){var e;try{e=new f}catch(r){try{e=new d}catch(r){e=new m}}return new v(e)}var v=function(){function e(e){this.database=e}return e.prototype.getItem=function(e){return this.database.getItem(e)},e.prototype.setItem=function(e,r){return this.database.setItem(e,r)},e.prototype.removeItem=function(e){return this.database.removeItem(e)},e.prototype.clear=function(){return this.database.clear()},e.decorators=[{type:r.Injectable}],e.ctorParameters=[null],e}(),f=function(){function e(){this.dbName="ngStorage",this.objectStoreName="localStorage",this.keyPath="key",this.dataPath="value",this.database=new o.ReplaySubject,this.connect()}return e.prototype.getItem=function(e){var r=this;return this.transaction().map(function(r){return r.get(e)}).mergeMap(function(e){var o=t.Observable.fromEvent(e,"success").pluck("target","result").map(function(e){return e?e[r.dataPath]:null});return t.Observable.merge(o,r.toErrorObservable(e,"getter")).first()})},e.prototype.setItem=function(e,r){var o=this;return this.getItem(e).map(function(e){return null==e?"add":"put"}).mergeMap(function(a){return o.transaction("readwrite").mergeMap(function(n){var s=n[a]((c={},c[o.dataPath]=r,c),e);return t.Observable.merge(o.toSuccessObservable(s),o.toErrorObservable(s,"setter")).first();var c})})},e.prototype.removeItem=function(e){var r=this;return this.getItem(e).mergeMap(function(o){return null!=o?r.transaction("readwrite").mergeMap(function(o){var a=o.delete(e);return t.Observable.merge(r.toSuccessObservable(a),r.toErrorObservable(a,"remover")).first()}):t.Observable.of(!0).first()})},e.prototype.clear=function(){var e=this;return this.transaction("readwrite").mergeMap(function(r){var o=r.clear();return t.Observable.merge(e.toSuccessObservable(o),e.toErrorObservable(o,"clearer")).first()})},e.prototype.connect=function(){var e=this,r=indexedDB.open(this.dbName);t.Observable.fromEvent(r,"upgradeneeded").first().subscribe(function(r){var t=r.target.result;t.objectStoreNames.contains(e.objectStoreName)||t.createObjectStore(e.objectStoreName)});var o=t.Observable.fromEvent(r,"success");t.Observable.merge(o,this.toErrorObservable(r,"connection")).first().subscribe(function(r){e.database.next(r.target.result)})},e.prototype.transaction=function(e){var r=this;return void 0===e&&(e="readonly"),this.database.map(function(t){return t.transaction([r.objectStoreName],e).objectStore(r.objectStoreName)})},e.prototype.toSuccessObservable=function(e){return t.Observable.fromEvent(e,"success").map(function(){return!0})},e.prototype.toErrorObservable=function(e,r){return void 0===r&&(r=""),t.Observable.fromEvent(e,"error").mergeMap(function(){return t.Observable.throw(new Error("IndexedDB "+r+" issue."))})},e.decorators=[{type:r.Injectable}],e.ctorParameters=[],e}(),d=function(){function e(){this.localStorage=localStorage}return e.prototype.getItem=function(e){var r;try{r=JSON.parse(this.localStorage.getItem(e))}catch(e){return t.Observable.throw(new Error("Invalid data in localStorage."))}return t.Observable.of(r)},e.prototype.setItem=function(e,r){return this.localStorage.setItem(e,JSON.stringify(r)),t.Observable.of(!0)},e.prototype.removeItem=function(e){return this.localStorage.removeItem(e),t.Observable.of(!0)},e.prototype.clear=function(){return this.localStorage.clear(),t.Observable.of(!0)},e.decorators=[{type:r.Injectable}],e.ctorParameters=[],e}(),m=function(){function e(){this.localStorage=new Map}return e.prototype.getItem=function(e){return t.Observable.of(this.localStorage.get(e))},e.prototype.setItem=function(e,r){return this.localStorage.set(e,r),t.Observable.of(!0)},e.prototype.removeItem=function(e){return this.localStorage.delete(e),t.Observable.of(!0)},e.prototype.clear=function(){return this.localStorage.clear(),t.Observable.of(!0)},e.decorators=[{type:r.Injectable}],e.ctorParameters=[],e}(),g=function(){function e(){}return e.decorators=[{type:r.NgModule,args:[{providers:[{provide:v,useFactory:p}]}]}],e.ctorParameters=[],e}();e.AsyncLocalStorageModule=g,e.AsyncLocalStorage=v,Object.defineProperty(e,"__esModule",{value:!0})});